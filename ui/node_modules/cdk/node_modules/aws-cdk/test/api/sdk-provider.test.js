"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cxapi = require("@aws-cdk/cx-api");
const AWS = require("aws-sdk");
const SDKMock = require("aws-sdk-mock");
const uuid = require("uuid");
const lib_1 = require("../../lib");
const aws_auth_1 = require("../../lib/api/aws-auth");
const logging = require("../../lib/logging");
const bockfs = require("../bockfs");
SDKMock.setSDKInstance(AWS);
const defaultCredOptions = {
    ec2creds: false,
    containerCreds: false,
};
// Account cache buster
let uid;
let pluginQueried = false;
let defaultEnv;
beforeEach(() => {
    uid = `(${uuid.v4()})`;
    logging.setLogLevel(2 /* TRACE */);
    bockfs({
        '/home/me/.bxt/credentials': dedent(`
      [default]
      aws_access_key_id=${uid}access
      aws_secret_access_key=secret

      [foo]
      aws_access_key_id=${uid}fooccess
      aws_secret_access_key=secret

      [assumer]
      aws_access_key_id=${uid}assumer
      aws_secret_access_key=secret
    `),
        '/home/me/.bxt/config': dedent(`
      [default]
      region=eu-bla-5

      [profile foo]
      region=eu-west-1

      [profile boo]
      aws_access_key_id=${uid}booccess
      aws_secret_access_key=boocret
      # No region here

      [profile assumable]
      role_arn=arn:aws:iam::12356789012:role/Assumable
      source_profile=assumer

      [profile assumer]
      region=us-east-2
    `),
    });
    SDKMock.mock('STS', 'getCallerIdentity', (cb) => {
        return cb(null, {
            Account: `${uid}the_account_#`,
            UserId: 'you!',
            Arn: 'arn:aws-here:iam::12345:role/test',
        });
    });
    lib_1.PluginHost.instance.credentialProviderSources.splice(0);
    lib_1.PluginHost.instance.credentialProviderSources.push({
        isAvailable() { return Promise.resolve(true); },
        canProvideCredentials(account) { return Promise.resolve(account === `${uid}plugin_account_#`); },
        getProvider() {
            pluginQueried = true;
            return Promise.resolve(new AWS.Credentials({
                accessKeyId: `${uid}plugin_key`,
                secretAccessKey: 'plugin_secret',
                sessionToken: 'plugin_token',
            }));
        },
        name: 'test plugin',
    });
    defaultEnv = cxapi.EnvironmentUtils.make(`${uid}the_account_#`, 'def');
    // Set environment variables that we want
    process.env.AWS_CONFIG_FILE = bockfs.path('/home/me/.bxt/config');
    process.env.AWS_SHARED_CREDENTIALS_FILE = bockfs.path('/home/me/.bxt/credentials');
    // Scrub some environment variables that might be set if we're running on CodeBuild which will interfere with the tests.
    delete process.env.AWS_REGION;
    delete process.env.AWS_DEFAULT_REGION;
    delete process.env.AWS_ACCESS_KEY_ID;
    delete process.env.AWS_SECRET_ACCESS_KEY;
    delete process.env.AWS_SESSION_TOKEN;
});
afterEach(() => {
    logging.setLogLevel(0 /* DEFAULT */);
    SDKMock.restore();
    bockfs.restore();
});
describe('CLI compatible credentials loading', () => {
    test('default config credentials', async () => {
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
        // THEN
        expect(provider.defaultRegion).toEqual('eu-bla-5');
        await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
        const sdk = await provider.forEnvironment({ ...defaultEnv, region: 'rgn' }, aws_auth_1.Mode.ForReading);
        expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}access`);
        expect(sdkConfig(sdk).region).toEqual('rgn');
    });
    test('unknown account and region uses current', async () => {
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
        // THEN
        const sdk = await provider.forEnvironment(cxapi.EnvironmentUtils.make(cxapi.UNKNOWN_ACCOUNT, cxapi.UNKNOWN_REGION), aws_auth_1.Mode.ForReading);
        expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}access`);
        expect(sdkConfig(sdk).region).toEqual('eu-bla-5');
    });
    test('mixed profile credentials', async () => {
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'foo' });
        // THEN
        expect(provider.defaultRegion).toEqual('eu-west-1');
        await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
        const sdk = await provider.forEnvironment(defaultEnv, aws_auth_1.Mode.ForReading);
        expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}fooccess`);
    });
    test('pure config credentials', async () => {
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'boo' });
        // THEN
        expect(provider.defaultRegion).toEqual('eu-bla-5'); // Fall back to default config
        await expect(provider.defaultAccount()).resolves.toEqual({ accountId: `${uid}the_account_#`, partition: 'aws-here' });
        const sdk = await provider.forEnvironment(defaultEnv, aws_auth_1.Mode.ForReading);
        expect(sdkConfig(sdk).credentials.accessKeyId).toEqual(`${uid}booccess`);
    });
    test('different account throws', async () => {
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions, profile: 'boo' });
        await expect(provider.forEnvironment({ ...defaultEnv, account: `${uid}some_account_#` }, aws_auth_1.Mode.ForReading)).rejects.toThrow('Need to perform AWS calls');
    });
    test('even when using a profile to assume another profile, STS calls goes through the proxy', async () => {
        // Messy mocking
        let called = false;
        jest.mock('proxy-agent', () => {
            // eslint-disable-next-line @typescript-eslint/no-require-imports
            class FakeAgent extends require('https').Agent {
                addRequest(_, __) {
                    // FIXME: this error takes 6 seconds to be completely handled. It
                    // might be retries in the SDK somewhere, or something about the Node
                    // event loop. I've spent an hour trying to figure it out and I can't,
                    // and I gave up. We'll just have to live with this until someone gets
                    // inspired.
                    const error = new Error('ABORTED BY TEST');
                    error.code = 'RequestAbortedError';
                    error.retryable = false;
                    called = true;
                    throw error;
                }
            }
            return FakeAgent;
        });
        // WHEN
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions,
            profile: 'assumable',
            httpOptions: {
                proxyAddress: 'http://DOESNTMATTER/',
            },
        });
        await provider.defaultAccount();
        // THEN -- the fake proxy agent got called, we don't care about the result
        expect(called).toEqual(true);
    });
    test('error we get from assuming a role is useful', async () => {
        // GIVEN
        // Because of the way ChainableTemporaryCredentials gets its STS client, it's not mockable
        // using 'mock-aws-sdk'. So instead, we have to mess around with its internals.
        function makeAssumeRoleFail(s) {
            s.credentials.service.assumeRole = jest.fn().mockImplementation((_request, cb) => {
                cb(new Error('Nope!'));
            });
        }
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({
            ...defaultCredOptions,
            httpOptions: {
                proxyAddress: 'http://localhost:8080/',
            },
        });
        // WHEN
        const sdk = await provider.withAssumedRole('bla.role.arn', undefined, undefined);
        makeAssumeRoleFail(sdk);
        // THEN - error message contains both a helpful hint and the underlying AssumeRole message
        await expect(sdk.s3().listBuckets().promise()).rejects.toThrow('did you bootstrap');
        await expect(sdk.s3().listBuckets().promise()).rejects.toThrow('Nope!');
    });
});
describe('Plugins', () => {
    test('does not use plugins if current credentials are for expected account', async () => {
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
        await provider.forEnvironment(defaultEnv, aws_auth_1.Mode.ForReading);
        expect(pluginQueried).toEqual(false);
    });
    test('uses plugin for other account', async () => {
        const provider = await aws_auth_1.SdkProvider.withAwsCliCompatibleDefaults({ ...defaultCredOptions });
        await provider.forEnvironment({ ...defaultEnv, account: `${uid}plugin_account_#` }, aws_auth_1.Mode.ForReading);
        expect(pluginQueried).toEqual(true);
    });
});
/**
 * Strip shared whitespace from the start of lines
 */
function dedent(x) {
    const lines = x.split('\n');
    while (lines.length > 0 && lines[0].trim() === '') {
        lines.shift();
    }
    while (lines.length > 0 && lines[lines.length - 1].trim() === '') {
        lines.pop();
    }
    const wsRe = /^\s*/;
    const lineParts = x.split('\n').map(s => {
        const ws = wsRe.exec(s)[0];
        return [ws, s.substr(ws.length)];
    });
    if (lineParts.length === 0) {
        return '';
    } // Reduce won't work well in this case
    // Calculate common whitespace only for non-empty lines
    const sharedWs = lineParts.reduce((commonWs, [ws, text]) => text !== '' ? commonPrefix(commonWs, ws) : commonWs, lineParts[0][0]);
    return lines.map(s => s.substr(sharedWs.length)).join('\n');
}
/**
 * Use object hackery to get the credentials out of the SDK object
 */
function sdkConfig(sdk) {
    return sdk.config;
}
function commonPrefix(a, b) {
    const N = Math.min(a.length, b.length);
    for (let i = 0; i < N; i++) {
        if (a[i] !== b[i]) {
            return a.substring(0, i);
        }
    }
    return a.substr(N);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2RrLXByb3ZpZGVyLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZGstcHJvdmlkZXIudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlDQUF5QztBQUN6QywrQkFBK0I7QUFDL0Isd0NBQXdDO0FBRXhDLDZCQUE2QjtBQUM3QixtQ0FBdUM7QUFDdkMscURBQWlFO0FBQ2pFLDZDQUE2QztBQUM3QyxvQ0FBb0M7QUFFcEMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUk1QixNQUFNLGtCQUFrQixHQUFHO0lBQ3pCLFFBQVEsRUFBRSxLQUFLO0lBQ2YsY0FBYyxFQUFFLEtBQUs7Q0FDdEIsQ0FBQztBQUVGLHVCQUF1QjtBQUN2QixJQUFJLEdBQVcsQ0FBQztBQUNoQixJQUFJLGFBQWEsR0FBRyxLQUFLLENBQUM7QUFDMUIsSUFBSSxVQUE2QixDQUFDO0FBRWxDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7SUFDZCxHQUFHLEdBQUcsSUFBSSxJQUFJLENBQUMsRUFBRSxFQUFFLEdBQUcsQ0FBQztJQUV2QixPQUFPLENBQUMsV0FBVyxlQUF3QixDQUFDO0lBRTVDLE1BQU0sQ0FBQztRQUNMLDJCQUEyQixFQUFFLE1BQU0sQ0FBQzs7MEJBRWQsR0FBRzs7OzswQkFJSCxHQUFHOzs7OzBCQUlILEdBQUc7O0tBRXhCLENBQUM7UUFDRixzQkFBc0IsRUFBRSxNQUFNLENBQUM7Ozs7Ozs7OzBCQVFULEdBQUc7Ozs7Ozs7Ozs7S0FVeEIsQ0FBQztLQUNILENBQUMsQ0FBQztJQUVILE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLG1CQUFtQixFQUFFLENBQUMsRUFBa0QsRUFBRSxFQUFFO1FBQzlGLE9BQU8sRUFBRSxDQUFDLElBQUksRUFBRTtZQUNkLE9BQU8sRUFBRSxHQUFHLEdBQUcsZUFBZTtZQUM5QixNQUFNLEVBQUUsTUFBTTtZQUNkLEdBQUcsRUFBRSxtQ0FBbUM7U0FDekMsQ0FBQyxDQUFDO0lBQ0ws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QUFDO0FBQzlELENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsU0FBUyxDQUFDLEdBQVM7SUFDMUIsT0FBUSxHQUFXLENBQUMsTUFBTSxDQUFDO0FBQzdCLENBQUM7QUFFRCxTQUFTLFlBQVksQ0FBQyxDQUFTLEVBQUUsQ0FBUztJQUN4QyxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3ZDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDMUIsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQUUsT0FBTyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUFFO0tBQ2pEO0lBQ0QsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3JCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjeGFwaSBmcm9tICdAYXdzLWNkay9jeC1hcGknO1xuaW1wb3J0ICogYXMgQVdTIGZyb20gJ2F3cy1zZGsnO1xuaW1wb3J0ICogYXMgU0RLTW9jayBmcm9tICdhd3Mtc2RrLW1vY2snO1xuaW1wb3J0IHsgQ29uZmlndXJhdGlvbk9wdGlvbnMgfSBmcm9tICdhd3Mtc2RrL2xpYi9jb25maWcnO1xuaW1wb3J0ICogYXMgdXVpZCBmcm9tICd1dWlkJztcbmltcG9ydCB7IFBsdWdpbkhvc3QgfSBmcm9tICcuLi8uLi9saWInO1xuaW1wb3J0IHsgSVNESywgTW9kZSwgU2RrUHJvdmlkZXIgfSBmcm9tICcuLi8uLi9saWIvYXBpL2F3cy1hdXRoJztcbmltcG9ydCAqIGFzIGxvZ2dpbmcgZnJvbSAnLi4vLi4vbGliL2xvZ2dpbmcnO1xuaW1wb3J0ICogYXMgYm9ja2ZzIGZyb20gJy4uL2JvY2tmcyc7XG5cblNES01vY2suc2V0U0RLSW5zdGFuY2UoQVdTKTtcblxudHlwZSBBd3NDYWxsYmFjazxUPiA9IChlcnI6IEVycm9yIHwgbnVsbCwgdmFsOiBUKSA9PiB2b2lkO1xuXG5jb25zdCBkZWZhdWx0Q3JlZE9wdGlvbnMgPSB7XG4gIGVjMmNyZWRzOiBmYWxzZSxcbiAgY29udGFpbmVyQ3JlZHM6IGZhbHNlLFxufTtcblxuLy8gQWNjb3VudCBjYWNoZSBidXN0ZXJcbmxldCB1aWQ6IHN0cmluZztcbmxldCBwbHVnaW5RdWVyaWVkID0gZmFsc2U7XG5sZXQgZGVmYXVsdEVudjogY3hhcGkuRW52aXJvbm1lbnQ7XG5cbmJlZm9yZUVhY2goKCkgPT4ge1xuICB1aWQgPSBgKCR7dXVpZC52NCgpfSlgO1xuXG4gIGxvZ2dpbmcuc2V0TG9nTGV2ZWwobG9nZ2luZy5Mb2dMZXZlbC5UUkFDRSk7XG5cbiAgYm9ja2ZzKHtcbiAgICAnL2hvbWUvbWUvLmJ4dC9jcmVkZW50aWFscyc6IGRlZGVudChgXG4gICAgICBbZGVmYXVsdF1cbiAgICAgIGF3c19hY2Nlc3Nfa2V5X2lkPSR7dWlkfWFjY2Vzc1xuICAgICAgYXdzX3NlY3JldF9hY2Nlc3Nfa2V5PXNlY3JldFxuXG4gICAgICBbZm9vXVxuICAgICAgYXdzX2FjY2Vzc19rZXlfaWQ9JHt1aWR9Zm9vY2Nlc3NcbiAgICAgIGF3c19zZWNyZXRfYWNjZXNzX2tleT1zZWNyZXRcblxuICAgICAgW2Fzc3VtZXJdXG4gICAgICBhd3NfYWNjZXNzX2tleV9pZD0ke3VpZH1hc3N1bWVyXG4gICAgICBhd3Nfc2VjcmV0X2FjY2Vzc19rZXk9c2VjcmV0XG4gICAgYCksXG4gICAgJy9ob21lL21lLy5ieHQvY29uZmlnJzogZGVkZW50KGBcbiAgICAgIFtkZWZhdWx0XVxuICAgICAgcmVnaW9uPWV1LWJsYS01XG5cbiAgICAgIFtwcm9maWxlIGZvb11cbiAgICAgIHJlZ2lvbj1ldS13ZXN0LTFcblxuICAgICAgW3Byb2ZpbGUgYm9vXVxuICAgICAgYXdzX2FjY2Vzc19rZXlfaWQ9JHt1aWR9Ym9vY2Nlc3NcbiAgICAgIGF3c19zZWNyZXRfYWNjZXNzX2tleT1ib29jcmV0XG4gICAgICAjIE5vIHJlZ2lvbiBoZXJlXG5cbiAgICAgIFtwcm9maWxlIGFzc3VtYWJsZV1cbiAgICAgIHJvbGVfYXJuPWFybjphd3M6aWFtOjoxMjM1Njc4OTAxMjpyb2xlL0Fzc3VtYWJsZVxuICAgICAgc291cmNlX3Byb2ZpbGU9YXNzdW1lclxuXG4gICAgICBbcHJvZmlsZSBhc3N1bWVyXVxuICAgICAgcmVnaW9uPXVzLWVhc3QtMlxuICAgIGApLFxuICB9KTtcblxuICBTREtNb2NrLm1vY2soJ1NUUycsICdnZXRDYWxsZXJJZGVudGl0eScsIChjYjogQXdzQ2FsbGJhY2s8QVdTLlNUUy5HZXRDYWxsZXJJZGVudGl0eVJlc3BvbnNlPikgPT4ge1xuICAgIHJldHVybiBjYihudWxsLCB7XG4gICAgICBBY2NvdW50OiBgJHt1aWR9dGhlX2FjY291bnRfI2AsXG4gICAgICBVc2VySWQ6ICd5b3UhJyxcbiAgICAgIEFybjogJ2Fybjphd3MtaGVyZTppYW06OjEyMzQ1OnJvbGUvdGVzdCcsXG4gICAgfSk7XG4gIH0pO1xuXG4gIFBsdWdpbkhvc3QuaW5zdGFuY2UuY3JlZGVudGlhbFByb3ZpZGVyU291cmNlcy5zcGxpY2UoMCk7XG4gIFBsdWdpbkhvc3QuaW5zdGFuY2UuY3JlZGVudGlhbFByb3ZpZGVyU291cmNlcy5wdXNoKHtcbiAgICBpc0F2YWlsYWJsZSgpIHsgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTsgfSxcbiAgICBjYW5Qcm92aWRlQ3JlZGVudGlhbHMoYWNjb3VudCkgeyByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGFjY291bnQgPT09IGAke3VpZH1wbHVnaW5fYWNjb3VudF8jYCk7IH0sXG4gICAgZ2V0UHJvdmlkZXIoKSB7XG4gICAgICBwbHVnaW5RdWVyaWVkID0gdHJ1ZTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobmV3IEFXUy5DcmVkZW50aWFscyh7XG4gICAgICAgIGFjY2Vzc0tleUlkOiBgJHt1aWR9cGx1Z2luX2tleWAsXG4gICAgICAgIHNlY3JldEFjY2Vzc0tleTogJ3BsdWdpbl9zZWNyZXQnLFxuICAgICAgICBzZXNzaW9uVG9rZW46ICdwbHVnaW5fdG9rZW4nLFxuICAgICAgfSkpO1xuICAgIH0sXG4gICAgbmFtZTogJ3Rlc3QgcGx1Z2luJyxcbiAgfSk7XG5cbiAgZGVmYXVsdEVudiA9IGN4YXBpLkVudmlyb25tZW50VXRpbHMubWFrZShgJHt1aWR9dGhlX2FjY291bnRfI2AsICdkZWYnKTtcblxuICAvLyBTZXQgZW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgd2Ugd2FudFxuICBwcm9jZXNzLmVudi5BV1NfQ09ORklHX0ZJTEUgPSBib2NrZnMucGF0aCgnL2hvbWUvbWUvLmJ4dC9jb25maWcnKTtcbiAgcHJvY2Vzcy5lbnYuQVdTX1NIQVJFRF9DUkVERU5USUFMU19GSUxFID0gYm9ja2ZzLnBhdGgoJy9ob21lL21lLy5ieHQvY3JlZGVudGlhbHMnKTtcbiAgLy8gU2NydWIgc29tZSBlbnZpcm9ubWVudCB2YXJpYWJsZXMgdGhhdCBtaWdodCBiZSBzZXQgaWYgd2UncmUgcnVubmluZyBvbiBDb2RlQnVpbGQgd2hpY2ggd2lsbCBpbnRlcmZlcmUgd2l0aCB0aGUgdGVzdHMuXG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfUkVHSU9OO1xuICBkZWxldGUgcHJvY2Vzcy5lbnYuQVdTX0RFRkFVTFRfUkVHSU9OO1xuICBkZWxldGUgcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVlfSUQ7XG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfU0VDUkVUX0FDQ0VTU19LRVk7XG4gIGRlbGV0ZSBwcm9jZXNzLmVudi5BV1NfU0VTU0lPTl9UT0tFTjtcbn0pO1xuXG5hZnRlckVhY2goKCkgPT4ge1xuICBsb2dnaW5nLnNldExvZ0xldmVsKGxvZ2dpbmcuTG9nTGV2ZWwuREVGQVVMVCk7XG5cbiAgU0RLTW9jay5yZXN0b3JlKCk7XG4gIGJvY2tmcy5yZXN0b3JlKCk7XG59KTtcblxuZGVzY3JpYmUoJ0NMSSBjb21wYXRpYmxlIGNyZWRlbnRpYWxzIGxvYWRpbmcnLCAoKSA9PiB7XG4gIHRlc3QoJ2RlZmF1bHQgY29uZmlnIGNyZWRlbnRpYWxzJywgYXN5bmMgKCkgPT4ge1xuICAgIC8vIFdIRU5cbiAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHByb3ZpZGVyLmRlZmF1bHRSZWdpb24pLnRvRXF1YWwoJ2V1LWJsYS01Jyk7XG4gICAgYXdhaXQgZXhwZWN0KHByb3ZpZGVyLmRlZmF1bHRBY2NvdW50KCkpLnJlc29sdmVzLnRvRXF1YWwoeyBhY2NvdW50SWQ6IGAke3VpZH10aGVfYWNjb3VudF8jYCwgcGFydGl0aW9uOiAnYXdzLWhlcmUnIH0pO1xuICAgIGNvbnN0IHNkayA9IGF3YWl0IHByb3ZpZGVyLmZvckVudmlyb25tZW50KHsgLi4uZGVmYXVsdEVudiwgcmVnaW9uOiAncmduJyB9LCBNb2RlLkZvclJlYWRpbmcpO1xuICAgIGV4cGVjdChzZGtDb25maWcoc2RrKS5jcmVkZW50aWFscyEuYWNjZXNzS2V5SWQpLnRvRXF1YWwoYCR7dWlkfWFjY2Vzc2ApO1xuICAgIGV4cGVjdChzZGtDb25maWcoc2RrKS5yZWdpb24pLnRvRXF1YWwoJ3JnbicpO1xuICB9KTtcblxuICB0ZXN0KCd1bmtub3duIGFjY291bnQgYW5kIHJlZ2lvbiB1c2VzIGN1cnJlbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7IC4uLmRlZmF1bHRDcmVkT3B0aW9ucyB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBjb25zdCBzZGsgPSBhd2FpdCBwcm92aWRlci5mb3JFbnZpcm9ubWVudChjeGFwaS5FbnZpcm9ubWVudFV0aWxzLm1ha2UoY3hhcGkuVU5LTk9XTl9BQ0NPVU5ULCBjeGFwaS5VTktOT1dOX1JFR0lPTiksIE1vZGUuRm9yUmVhZGluZyk7XG4gICAgZXhwZWN0KHNka0NvbmZpZyhzZGspLmNyZWRlbnRpYWxzIS5hY2Nlc3NLZXlJZCkudG9FcXVhbChgJHt1aWR9YWNjZXNzYCk7XG4gICAgZXhwZWN0KHNka0NvbmZpZyhzZGspLnJlZ2lvbikudG9FcXVhbCgnZXUtYmxhLTUnKTtcbiAgfSk7XG5cbiAgdGVzdCgnbWl4ZWQgcHJvZmlsZSBjcmVkZW50aWFscycsIGFzeW5jICgpID0+IHtcbiAgICAvLyBXSEVOXG4gICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHsgLi4uZGVmYXVsdENyZWRPcHRpb25zLCBwcm9maWxlOiAnZm9vJyB9KTtcblxuICAgIC8vIFRIRU5cbiAgICBleHBlY3QocHJvdmlkZXIuZGVmYXVsdFJlZ2lvbikudG9FcXVhbCgnZXUtd2VzdC0xJyk7XG4gICAgYXdhaXQgZXhwZWN0KHByb3ZpZGVyLmRlZmF1bHRBY2NvdW50KCkpLnJlc29sdmVzLnRvRXF1YWwoeyBhY2NvdW50SWQ6IGAke3VpZH10aGVfYWNjb3VudF8jYCwgcGFydGl0aW9uOiAnYXdzLWhlcmUnIH0pO1xuICAgIGNvbnN0IHNkayA9IGF3YWl0IHByb3ZpZGVyLmZvckVudmlyb25tZW50KGRlZmF1bHRFbnYsIE1vZGUuRm9yUmVhZGluZyk7XG4gICAgZXhwZWN0KHNka0NvbmZpZyhzZGspLmNyZWRlbnRpYWxzIS5hY2Nlc3NLZXlJZCkudG9FcXVhbChgJHt1aWR9Zm9vY2Nlc3NgKTtcbiAgfSk7XG5cbiAgdGVzdCgncHVyZSBjb25maWcgY3JlZGVudGlhbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7IC4uLmRlZmF1bHRDcmVkT3B0aW9ucywgcHJvZmlsZTogJ2JvbycgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHByb3ZpZGVyLmRlZmF1bHRSZWdpb24pLnRvRXF1YWwoJ2V1LWJsYS01Jyk7ICAvLyBGYWxsIGJhY2sgdG8gZGVmYXVsdCBjb25maWdcbiAgICBhd2FpdCBleHBlY3QocHJvdmlkZXIuZGVmYXVsdEFjY291bnQoKSkucmVzb2x2ZXMudG9FcXVhbCh7IGFjY291bnRJZDogYCR7dWlkfXRoZV9hY2NvdW50XyNgLCBwYXJ0aXRpb246ICdhd3MtaGVyZScgfSk7XG4gICAgY29uc3Qgc2RrID0gYXdhaXQgcHJvdmlkZXIuZm9yRW52aXJvbm1lbnQoZGVmYXVsdEVudiwgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICBleHBlY3Qoc2RrQ29uZmlnKHNkaykuY3JlZGVudGlhbHMhLmFjY2Vzc0tleUlkKS50b0VxdWFsKGAke3VpZH1ib29jY2Vzc2ApO1xuICB9KTtcblxuICB0ZXN0KCdkaWZmZXJlbnQgYWNjb3VudCB0aHJvd3MnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcHJvdmlkZXIgPSBhd2FpdCBTZGtQcm92aWRlci53aXRoQXdzQ2xpQ29tcGF0aWJsZURlZmF1bHRzKHsgLi4uZGVmYXVsdENyZWRPcHRpb25zLCBwcm9maWxlOiAnYm9vJyB9KTtcblxuICAgIGF3YWl0IGV4cGVjdChwcm92aWRlci5mb3JFbnZpcm9ubWVudCh7Li4uZGVmYXVsdEVudiwgYWNjb3VudDogYCR7dWlkfXNvbWVfYWNjb3VudF8jYCB9LCBNb2RlLkZvclJlYWRpbmcpKS5yZWplY3RzLnRvVGhyb3coJ05lZWQgdG8gcGVyZm9ybSBBV1MgY2FsbHMnKTtcbiAgfSk7XG5cbiAgdGVzdCgnZXZlbiB3aGVuIHVzaW5nIGEgcHJvZmlsZSB0byBhc3N1bWUgYW5vdGhlciBwcm9maWxlLCBTVFMgY2FsbHMgZ29lcyB0aHJvdWdoIHRoZSBwcm94eScsIGFzeW5jICgpID0+IHtcbiAgICAvLyBNZXNzeSBtb2NraW5nXG4gICAgbGV0IGNhbGxlZCA9IGZhbHNlO1xuICAgIGplc3QubW9jaygncHJveHktYWdlbnQnLCAoKSA9PiB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLXJlcXVpcmUtaW1wb3J0c1xuICAgICAgY2xhc3MgRmFrZUFnZW50IGV4dGVuZHMgcmVxdWlyZSgnaHR0cHMnKS5BZ2VudCB7XG4gICAgICAgIHB1YmxpYyBhZGRSZXF1ZXN0KF86IGFueSwgX186IGFueSkge1xuICAgICAgICAgIC8vIEZJWE1FOiB0aGlzIGVycm9yIHRha2VzIDYgc2Vjb25kcyB0byBiZSBjb21wbGV0ZWx5IGhhbmRsZWQuIEl0XG4gICAgICAgICAgLy8gbWlnaHQgYmUgcmV0cmllcyBpbiB0aGUgU0RLIHNvbWV3aGVyZSwgb3Igc29tZXRoaW5nIGFib3V0IHRoZSBOb2RlXG4gICAgICAgICAgLy8gZXZlbnQgbG9vcC4gSSd2ZSBzcGVudCBhbiBob3VyIHRyeWluZyB0byBmaWd1cmUgaXQgb3V0IGFuZCBJIGNhbid0LFxuICAgICAgICAgIC8vIGFuZCBJIGdhdmUgdXAuIFdlJ2xsIGp1c3QgaGF2ZSB0byBsaXZlIHdpdGggdGhpcyB1bnRpbCBzb21lb25lIGdldHNcbiAgICAgICAgICAvLyBpbnNwaXJlZC5cbiAgICAgICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignQUJPUlRFRCBCWSBURVNUJyk7XG4gICAgICAgICAgKGVycm9yIGFzIGFueSkuY29kZSA9ICdSZXF1ZXN0QWJvcnRlZEVycm9yJztcbiAgICAgICAgICAoZXJyb3IgYXMgYW55KS5yZXRyeWFibGUgPSBmYWxzZTtcbiAgICAgICAgICBjYWxsZWQgPSB0cnVlO1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gRmFrZUFnZW50O1xuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7IC4uLmRlZmF1bHRDcmVkT3B0aW9ucyxcbiAgICAgIHByb2ZpbGU6ICdhc3N1bWFibGUnLFxuICAgICAgaHR0cE9wdGlvbnM6IHtcbiAgICAgICAgcHJveHlBZGRyZXNzOiAnaHR0cDovL0RPRVNOVE1BVFRFUi8nLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGF3YWl0IHByb3ZpZGVyLmRlZmF1bHRBY2NvdW50KCk7XG5cbiAgICAvLyBUSEVOIC0tIHRoZSBmYWtlIHByb3h5IGFnZW50IGdvdCBjYWxsZWQsIHdlIGRvbid0IGNhcmUgYWJvdXQgdGhlIHJlc3VsdFxuICAgIGV4cGVjdChjYWxsZWQpLnRvRXF1YWwodHJ1ZSk7XG4gIH0pO1xuXG4gIHRlc3QoJ2Vycm9yIHdlIGdldCBmcm9tIGFzc3VtaW5nIGEgcm9sZSBpcyB1c2VmdWwnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gR0lWRU5cbiAgICAvLyBCZWNhdXNlIG9mIHRoZSB3YXkgQ2hhaW5hYmxlVGVtcG9yYXJ5Q3JlZGVudGlhbHMgZ2V0cyBpdHMgU1RTIGNsaWVudCwgaXQncyBub3QgbW9ja2FibGVcbiAgICAvLyB1c2luZyAnbW9jay1hd3Mtc2RrJy4gU28gaW5zdGVhZCwgd2UgaGF2ZSB0byBtZXNzIGFyb3VuZCB3aXRoIGl0cyBpbnRlcm5hbHMuXG4gICAgZnVuY3Rpb24gbWFrZUFzc3VtZVJvbGVGYWlsKHM6IElTREspIHtcbiAgICAgIChzIGFzIGFueSkuY3JlZGVudGlhbHMuc2VydmljZS5hc3N1bWVSb2xlID0gamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoX3JlcXVlc3QsIGNiKSA9PiB7XG4gICAgICAgIGNiKG5ldyBFcnJvcignTm9wZSEnKSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoe1xuICAgICAgLi4uZGVmYXVsdENyZWRPcHRpb25zLFxuICAgICAgaHR0cE9wdGlvbnM6IHtcbiAgICAgICAgcHJveHlBZGRyZXNzOiAnaHR0cDovL2xvY2FsaG9zdDo4MDgwLycsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gV0hFTlxuICAgIGNvbnN0IHNkayA9IGF3YWl0IHByb3ZpZGVyLndpdGhBc3N1bWVkUm9sZSgnYmxhLnJvbGUuYXJuJywgdW5kZWZpbmVkLCB1bmRlZmluZWQpO1xuICAgIG1ha2VBc3N1bWVSb2xlRmFpbChzZGspO1xuXG4gICAgLy8gVEhFTiAtIGVycm9yIG1lc3NhZ2UgY29udGFpbnMgYm90aCBhIGhlbHBmdWwgaGludCBhbmQgdGhlIHVuZGVybHlpbmcgQXNzdW1lUm9sZSBtZXNzYWdlXG4gICAgYXdhaXQgZXhwZWN0KHNkay5zMygpLmxpc3RCdWNrZXRzKCkucHJvbWlzZSgpKS5yZWplY3RzLnRvVGhyb3coJ2RpZCB5b3UgYm9vdHN0cmFwJyk7XG4gICAgYXdhaXQgZXhwZWN0KHNkay5zMygpLmxpc3RCdWNrZXRzKCkucHJvbWlzZSgpKS5yZWplY3RzLnRvVGhyb3coJ05vcGUhJyk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCdQbHVnaW5zJywgKCkgPT4ge1xuICB0ZXN0KCdkb2VzIG5vdCB1c2UgcGx1Z2lucyBpZiBjdXJyZW50IGNyZWRlbnRpYWxzIGFyZSBmb3IgZXhwZWN0ZWQgYWNjb3VudCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBwcm92aWRlciA9IGF3YWl0IFNka1Byb3ZpZGVyLndpdGhBd3NDbGlDb21wYXRpYmxlRGVmYXVsdHMoeyAuLi5kZWZhdWx0Q3JlZE9wdGlvbnMgfSk7XG4gICAgYXdhaXQgcHJvdmlkZXIuZm9yRW52aXJvbm1lbnQoZGVmYXVsdEVudiwgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICBleHBlY3QocGx1Z2luUXVlcmllZCkudG9FcXVhbChmYWxzZSk7XG4gIH0pO1xuXG4gIHRlc3QoJ3VzZXMgcGx1Z2luIGZvciBvdGhlciBhY2NvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHByb3ZpZGVyID0gYXdhaXQgU2RrUHJvdmlkZXIud2l0aEF3c0NsaUNvbXBhdGlibGVEZWZhdWx0cyh7IC4uLmRlZmF1bHRDcmVkT3B0aW9ucyB9KTtcbiAgICBhd2FpdCBwcm92aWRlci5mb3JFbnZpcm9ubWVudCh7Li4uZGVmYXVsdEVudiwgYWNjb3VudDogYCR7dWlkfXBsdWdpbl9hY2NvdW50XyNgfSwgTW9kZS5Gb3JSZWFkaW5nKTtcbiAgICBleHBlY3QocGx1Z2luUXVlcmllZCkudG9FcXVhbCh0cnVlKTtcbiAgfSk7XG59KTtcblxuLyoqXG4gKiBTdHJpcCBzaGFyZWQgd2hpdGVzcGFjZSBmcm9tIHRoZSBzdGFydCBvZiBsaW5lc1xuICovXG5mdW5jdGlvbiBkZWRlbnQoeDogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgbGluZXMgPSB4LnNwbGl0KCdcXG4nKTtcbiAgd2hpbGUgKGxpbmVzLmxlbmd0aCA+IDAgJiYgbGluZXNbMF0udHJpbSgpID09PSAnJykgeyBsaW5lcy5zaGlmdCgpOyB9XG4gIHdoaWxlIChsaW5lcy5sZW5ndGggPiAwICYmIGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdLnRyaW0oKSA9PT0gJycpIHsgbGluZXMucG9wKCk7IH1cblxuICBjb25zdCB3c1JlID0gL15cXHMqLztcbiAgY29uc3QgbGluZVBhcnRzOiBBcnJheTxbc3RyaW5nLCBzdHJpbmddPiA9IHguc3BsaXQoJ1xcbicpLm1hcChzID0+IHtcbiAgICBjb25zdCB3cyA9IHdzUmUuZXhlYyhzKSFbMF07XG4gICAgcmV0dXJuIFt3cywgcy5zdWJzdHIod3MubGVuZ3RoKV07XG4gIH0pO1xuXG4gIGlmIChsaW5lUGFydHMubGVuZ3RoID09PSAwKSB7IHJldHVybiAnJzsgfSAgLy8gUmVkdWNlIHdvbid0IHdvcmsgd2VsbCBpbiB0aGlzIGNhc2VcblxuICAvLyBDYWxjdWxhdGUgY29tbW9uIHdoaXRlc3BhY2Ugb25seSBmb3Igbm9uLWVtcHR5IGxpbmVzXG4gIGNvbnN0IHNoYXJlZFdzID0gbGluZVBhcnRzLnJlZHVjZSgoY29tbW9uV3M6IHN0cmluZywgW3dzLCB0ZXh0XSkgPT4gdGV4dCAhPT0gJycgPyBjb21tb25QcmVmaXgoY29tbW9uV3MsIHdzKSA6IGNvbW1vbldzLCBsaW5lUGFydHNbMF1bMF0pO1xuICByZXR1cm4gbGluZXMubWFwKHMgPT4gcy5zdWJzdHIoc2hhcmVkV3MubGVuZ3RoKSkuam9pbignXFxuJyk7XG59XG5cbi8qKlxuICogVXNlIG9iamVjdCBoYWNrZXJ5IHRvIGdldCB0aGUgY3JlZGVudGlhbHMgb3V0IG9mIHRoZSBTREsgb2JqZWN0XG4gKi9cbmZ1bmN0aW9uIHNka0NvbmZpZyhzZGs6IElTREspOiBDb25maWd1cmF0aW9uT3B0aW9ucyB7XG4gIHJldHVybiAoc2RrIGFzIGFueSkuY29uZmlnO1xufVxuXG5mdW5jdGlvbiBjb21tb25QcmVmaXgoYTogc3RyaW5nLCBiOiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBOID0gTWF0aC5taW4oYS5sZW5ndGgsIGIubGVuZ3RoKTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBOOyBpKyspIHtcbiAgICBpZiAoYVtpXSAhPT0gYltpXSkgeyByZXR1cm4gYS5zdWJzdHJpbmcoMCwgaSk7IH1cbiAgfVxuICByZXR1cm4gYS5zdWJzdHIoTik7XG59XG4iXX0=